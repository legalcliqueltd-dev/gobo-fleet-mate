# iReport / Proof of Delivery System

## Overview

The iReport system enables task assignment to drivers with comprehensive proof of delivery capture, including QR/OTP verification, photos, signatures, and GPS tracking.

## Features

### Driver Interface

**Task List (`/driver/tasks`)**
- View assigned tasks with status (Assigned/En route/Delivered/Failed)
- See distance to dropoff location
- Start trip (mark as "en route")
- Real-time updates via Supabase Realtime

**Task Completion Wizard (`/tasks/:id/complete`)**
Multi-step completion process:

1. **Verify Delivery** (3 methods):
   - **Geofence**: Automatic verification if within dropoff radius (default 150m)
   - **OTP**: Enter 6-digit code from receiver (15-minute expiry)
   - **QR Code**: Scan receiver's QR code

2. **Capture Proof**:
   - Receiver name (required) and phone (optional)
   - Multiple photos (package, delivery site)
   - Signature capture
   - Optional notes

3. **Review & Submit**:
   - Review all captured information
   - Submit creates task_report and marks task as delivered

### Operations Console (`/ops/tasks`)

- **Task Dashboard**: List all tasks with status filters
- **Map View**: Visual representation of all tasks on map
- **Task Details**: View complete task information including:
  - Delivery location
  - Proof of delivery photos
  - Receiver signature
  - Verification method
  - Distance from dropoff point
  - Receiver information
- **CSV Export**: Export task data for reporting

## Database Schema

### Tables

1. **tasks**: Task assignments
   - Pickup/dropoff locations with radius
   - QR secret and OTP hash for verification
   - Status tracking (assigned/en_route/delivered/failed/cancelled)
   - Due dates and device assignment

2. **task_reports**: Proof of delivery records
   - Verification method (qr/otp/geofence/none)
   - Receiver information
   - GPS coordinates at delivery
   - Distance to dropoff point
   - Signature and photos (stored in Storage)
   - Optional notes

### Security

- **RLS Policies**: 
  - Drivers see only their assigned tasks
  - Admins see all tasks and reports
  - Task creators see tasks they created
- **Security Definer Function**: `has_role()` prevents RLS recursion
- **Storage Policies**: Users can only access their own proofs; admins see all

## Storage

**Bucket: `proofs`** (private)
- Photos: `{user_id}/{task_id}/{timestamp}_filename.jpg`
- Signatures: `{user_id}/{task_id}/signature_{timestamp}.png`
- RLS policies ensure users can only upload to their own folder
- Admins have read access to all proofs

## OTP System

**Edge Function: `pod-otp`**

Generate OTP:
```typescript
await supabase.functions.invoke('pod-otp', {
  body: { action: 'generate', taskId: 'uuid' }
});
// Returns: { otp: '123456', expiresAt: 'timestamp' }
```

Verify OTP:
```typescript
await supabase.functions.invoke('pod-otp', {
  body: { action: 'verify', taskId: 'uuid', otp: '123456' }
});
// Returns: { verified: true/false }
```

- OTPs are hashed (SHA-256) before storage
- 15-minute expiry window
- Simple salt (use proper salt in production)

## QR Code System

QR payload format:
```json
{
  "task_id": "uuid",
  "qr_secret": "random_string"
}
```

- `qr_secret` is stored in the task record
- QR code should be generated by ops/admin for receiver
- Driver scans QR at delivery to verify

## Verification Logic

Task completion requires ONE of:
1. **Geofence**: Current location within `dropoff_radius_m`
2. **OTP**: Valid, non-expired code
3. **QR**: Matching task_id and qr_secret

If geofence fails but OTP/QR succeeds, delivery is still allowed (for cases where GPS is inaccurate).

## Distance Calculation

Uses Haversine formula to calculate distance between:
- Driver's current location
- Task dropoff coordinates

Stored in `task_reports.distance_to_dropoff_m` for audit trail.

## Notifications

Future enhancement: Use existing `sos-dispatch` pattern to:
- Notify driver when task is assigned
- Notify dispatcher when task is completed
- Notify dispatcher if task fails

## Testing

1. **Create a test task** (as admin in Supabase SQL Editor):
```sql
insert into public.tasks (
  created_by, 
  assigned_user_id, 
  title, 
  dropoff_lat, 
  dropoff_lng,
  qr_secret
) values (
  'admin-user-id',
  'driver-user-id',
  'Test Delivery',
  40.7128,
  -74.0060,
  'test-secret-123'
);
```

2. **As driver**:
   - Navigate to `/driver/tasks`
   - Click task and mark "Start Trip"
   - Go to completion wizard
   - Complete verification and capture steps

3. **As ops**:
   - Navigate to `/ops/tasks`
   - View delivered tasks
   - Click to see proof details on map
   - Export CSV

## Dependencies

- `react-signature-canvas`: Digital signature capture
- `react-qr-scanner`: QR code scanning
- Capacitor Camera (future): Native camera access for mobile

## Future Enhancements

- Offline mode: Queue tasks locally, sync when online
- Route optimization: Suggest optimal delivery order
- Estimated time of arrival (ETA)
- Customer notification: SMS/email when driver is nearby
- Failed delivery reasons: Predefined failure codes
- Photo requirements: Enforce minimum number of photos
- Signature requirement: Make optional/required per task
